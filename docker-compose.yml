
networks:
  rhpartners_network:
    driver: bridge
  proxy:
    external: true

volumes:
  pgdata:
  static_volume:
  media_volume:
  dbbackups:
  logs_volume:

x-logging-rotated: &logging_rotated
  driver: "json-file"
  options:
    max-size: "10m"
    max-file: "3"

services:
  rhp_db:
    image: postgres:16
    restart: unless-stopped
    environment:
      TZ: Africa/Abidjan
      POSTGRES_DB: ${DB_NAME}
      POSTGRES_USER: ${DB_USER}
      POSTGRES_PASSWORD: ${DB_PASSWORD}
    volumes:
      - pgdata:/var/lib/postgresql/data
    networks: [rhpartners_network]
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U $$POSTGRES_USER -d $$POSTGRES_DB -h 127.0.0.1 || exit 1"]
      interval: 30s
      timeout: 5s
      retries: 10
    logging: *logging_rotated
    cpus: "1.2"
    mem_limit: 1200m
    mem_reservation: 512m
    ulimits:
      nofile: 65535

  rhp_redis:
    image: redis:7
    restart: unless-stopped
    environment:
      TZ: Africa/Abidjan
    command: ["redis-server","--appendonly","yes","--appendfsync","everysec","--save","900 1"]
    networks: [rhpartners_network]
    healthcheck:
      test: ["CMD-SHELL", "redis-cli -h 127.0.0.1 ping | grep PONG >/dev/null 2>&1 || exit 1"]
      interval: 30s
      timeout: 5s
      retries: 10
    logging: *logging_rotated
    cpus: "0.6"
    mem_limit: 512m
    mem_reservation: 256m
    ulimits:
      nofile: 65535

  rhp_web:
    build:
      context: .
      dockerfile: Dockerfile
    command: >
      gunicorn rhpartnersafric.wsgi:application
      --bind 0.0.0.0:8000
      --workers 2 --threads 1
      --worker-tmp-dir /dev/shm
      --max-requests 800 --max-requests-jitter 200
      --timeout 120 --graceful-timeout 60
      --keep-alive 5
      --log-level info
      --error-logfile - --access-logfile -
      --capture-output
      --forwarded-allow-ips="*"
    env_file: [.env]
    environment:
      TZ: Africa/Abidjan
      DJANGO_SETTINGS_MODULE: rhpartnersafric.settings
      PYTHONUNBUFFERED: "1"

      # DB (active la branche postgres dans base.py)
      DB_ENGINE: "postgres"
      DB_HOST: "rhp_db"
      DB_PORT: "5432"
      DB_NAME: ${DB_NAME}
      DB_USER: ${DB_USER}
      DB_PASSWORD: ${DB_PASSWORD}

      # Redis / Cache
      REDIS_URL: "redis://rhp_redis:6379/1"

      # Celery
      CELERY_BROKER_URL: "redis://rhp_redis:6379/0"
      CELERY_RESULT_BACKEND: "redis://rhp_redis:6379/0"

      # WhiteNoise / statics
      WHITENOISE_MAX_AGE: "2592000"
      WHITENOISE_USE_FINDERS: "False"
      DJANGO_MEDIA_ROOT: /var/www/media

      # Flags optionnels (si ton entrypoint les gère)
      RUN_MIGRATIONS: "0"
      RUN_COLLECTSTATIC: "1"

    volumes:
      # adapte les chemins si ton Dockerfile n'utilise pas /app
#      - static_volume:/app/static
      - static_volume:/app/staticfiles
      - media_volume:/var/www/media:rw
      - dbbackups:/app/dbbackup
      - logs_volume:/app/logs:rw

    depends_on:
      rhp_db:
        condition: service_healthy
      rhp_redis:
        condition: service_healthy

    restart: unless-stopped
    networks: [rhpartners_network, proxy]
    init: true

    # Sécurité & perf
    read_only: true
    tmpfs:
      - /tmp:size=128m,mode=1777
    shm_size: "256m"
    security_opt:
      - no-new-privileges:true
    ulimits:
      nofile: 65535

    labels:
      - traefik.enable=true
      - traefik.docker.network=proxy

      - traefik.http.routers.rhp.rule=Host(`${RHP_HOST}`)
      - traefik.http.routers.rhp.entrypoints=websecure
      - traefik.http.routers.rhp.tls=true
      - traefik.http.routers.rhp.tls.certresolver=lets
      - traefik.http.routers.rhp.service=rhp-svc

      - traefik.http.services.rhp-svc.loadbalancer.server.port=8000
      - traefik.http.services.rhp-svc.loadbalancer.server.scheme=http

      - traefik.http.routers.rhp.middlewares=rhp-sec-headers@docker,rhp-compress@docker,rhp-rl@docker
      - traefik.http.middlewares.rhp-sec-headers.headers.stsSeconds=31536000
      - traefik.http.middlewares.rhp-sec-headers.headers.stsIncludeSubdomains=true
      - traefik.http.middlewares.rhp-sec-headers.headers.stsPreload=true
      - traefik.http.middlewares.rhp-sec-headers.headers.contentTypeNosniff=true
      - traefik.http.middlewares.rhp-sec-headers.headers.frameDeny=true
      - traefik.http.middlewares.rhp-sec-headers.headers.referrerPolicy=strict-origin-when-cross-origin
      - traefik.http.middlewares.rhp-compress.compress=true
      - traefik.http.middlewares.rhp-rl.ratelimit.average=150
      - traefik.http.middlewares.rhp-rl.ratelimit.burst=250

    logging: *logging_rotated
    cpus: "1.5"
    mem_limit: 1024m
    mem_reservation: 512m

  rhp_celeryworker:
    build:
      context: .
      dockerfile: Dockerfile
    command: >
      celery -A rhpartnersafric worker
      --loglevel=warning
      --concurrency=2
      --prefetch-multiplier=1 -Ofair
      --max-tasks-per-child=200
      --without-gossip --without-mingle
    env_file: [.env]
    environment:
      TZ: Africa/Abidjan

      DB_ENGINE: "postgres"
      DB_HOST: "rhp_db"
      DB_PORT: "5432"
      DB_NAME: ${DB_NAME}
      DB_USER: ${DB_USER}
      DB_PASSWORD: ${DB_PASSWORD}

      REDIS_URL: "redis://rhp_redis:6379/1"
      CELERY_BROKER_URL: "redis://rhp_redis:6379/0"
      CELERY_RESULT_BACKEND: "redis://rhp_redis:6379/0"

      CELERY_WORKER_MAX_MEMORY_PER_CHILD: "200000"
      DJANGO_SETTINGS_MODULE: rhpartnersafric.settings
      PYTHONUNBUFFERED: "1"

    depends_on:
      rhp_db:
        condition: service_healthy
      rhp_redis:
        condition: service_healthy
    restart: unless-stopped
    networks: [rhpartners_network]
    healthcheck:
      test: ["CMD-SHELL", "ps aux | grep 'celery -A rhpartnersafric worker' | grep -v grep >/dev/null && redis-cli -h rhp_redis ping | grep PONG >/dev/null 2>&1 || exit 1"]
      interval: 30s
      timeout: 5s
      retries: 10
    logging: *logging_rotated
    cpus: "1.0"
    mem_limit: 768m
    mem_reservation: 384m
    ulimits:
      nofile: 65535

  rhp_celerybeat:
    build:
      context: .
      dockerfile: Dockerfile
    command: >
      celery -A rhpartnersafric beat
      --loglevel=warning
      --scheduler django_celery_beat.schedulers:DatabaseScheduler
      --pidfile=/tmp/celerybeat.pid
    env_file: [.env]
    environment:
      TZ: Africa/Abidjan

      DB_ENGINE: "postgres"
      DB_HOST: "rhp_db"
      DB_PORT: "5432"
      DB_NAME: ${DB_NAME}
      DB_USER: ${DB_USER}
      DB_PASSWORD: ${DB_PASSWORD}

      REDIS_URL: "redis://rhp_redis:6379/1"
      CELERY_BROKER_URL: "redis://rhp_redis:6379/0"
      CELERY_RESULT_BACKEND: "redis://rhp_redis:6379/0"

      DJANGO_SETTINGS_MODULE: rhpartnersafric.settings
      PYTHONUNBUFFERED: "1"

    depends_on:
      rhp_db:
        condition: service_healthy
      rhp_redis:
        condition: service_healthy
    restart: unless-stopped
    networks: [rhpartners_network]
    logging: *logging_rotated
    cpus: "0.3"
    mem_limit: 256m
    mem_reservation: 128m

  rhp_adminer:
    image: adminer
    restart: unless-stopped
    environment:
      TZ: Africa/Abidjan
      ADMINER_DEFAULT_SERVER: rhp_db
    depends_on:
      rhp_db:
        condition: service_healthy
    networks: [rhpartners_network, proxy]
    labels:
      - traefik.enable=true
      - traefik.docker.network=proxy
      - traefik.http.routers.rhpadminer.rule=Host(`adminer.${RHP_HOST}`)
      - traefik.http.routers.rhpadminer.entrypoints=websecure
      - traefik.http.routers.rhpadminer.tls=true
      - traefik.http.routers.rhpadminer.tls.certresolver=lets
      - traefik.http.services.rhpadminer.loadbalancer.server.port=8080
      - traefik.http.services.rhpadminer.loadbalancer.server.scheme=http
    logging: *logging_rotated
    cpus: "0.3"
    mem_limit: 256m
    mem_reservation: 128m